<!DOCTYPE html>
<html lang="en">
  <head>
    <title>COVID-19 CT segmentation demo</title>
    <!--Automatically generated by pyclientsideml. https://github.com/pbizopoulos/pyclientsideml-->
    <meta charset="UTF-8">
    <link href="data:" rel="icon">
    <link href="https://cdn.jsdelivr.net/npm/tui-color-picker@latest/dist/tui-color-picker.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tui-image-editor@latest/dist/tui-image-editor.min.css" rel="stylesheet">
    <style>
#divInputControl{
        border-style: groove;
        }

#divInput{
        border-style: groove;
        }

#divOutput{
        border-style: groove;
        }

#divInput:hover{
        border-style: solid;
        }
</style>
    <style>
.modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        }

.modal-content {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 70%;
        }
</style>
    <script src="https://cdn.jsdelivr.net/npm/tui-code-snippet@1.5.2/dist/tui-code-snippet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tui-color-picker@latest/dist/tui-color-picker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tui-image-editor@latest/dist/tui-image-editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  </head>
  <body>
    <div id="divInputControl" style="width:256px;height:256px;position:fixed;top:0px;left:0px;">
      <div>NOT FOR MEDICAL USE. Choose a lung CT image (.jpg,.png,.gif) and segment COVID-19 lesions using a DNN.</div>
      <div>
        <a href="https://github.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-in-ct">[url]</a>
      </div>
      <div>
        <input accept="image/*" onchange="imageSegmentationLoadView();" type="file">
      </div>
      <div>
        <select id="selectModel" onchange="loadModel(predictionFunction);" style="width:100%;">
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.FPN.mobilenet_v2.imagenet/model.json">lesion-segmentation-a.FPN.mobilenet_v2.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.FPN.resnet18.imagenet/model.json">lesion-segmentation-a.FPN.resnet18.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.FPN.vgg11.imagenet/model.json">lesion-segmentation-a.FPN.vgg11.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.FPN.vgg13.imagenet/model.json">lesion-segmentation-a.FPN.vgg13.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.Linknet.mobilenet_v2.imagenet/model.json">lesion-segmentation-a.Linknet.mobilenet_v2.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.Linknet.resnet18.imagenet/model.json">lesion-segmentation-a.Linknet.resnet18.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.Linknet.vgg11.imagenet/model.json">lesion-segmentation-a.Linknet.vgg11.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.Linknet.vgg13.imagenet/model.json">lesion-segmentation-a.Linknet.vgg13.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lesion-segmentation-a.Unet.mobilenet_v2.imagenet/model.json">lesion-segmentation-a.Unet.mobilenet_v2.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.FPN.mobilenet_v2.imagenet/model.json">lung-segmentation.FPN.mobilenet_v2.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.FPN.resnet18.imagenet/model.json">lung-segmentation.FPN.resnet18.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.FPN.vgg11.imagenet/model.json">lung-segmentation.FPN.vgg11.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.FPN.vgg13.imagenet/model.json">lung-segmentation.FPN.vgg13.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.Linknet.mobilenet_v2.imagenet/model.json">lung-segmentation.Linknet.mobilenet_v2.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.Linknet.resnet18.imagenet/model.json">lung-segmentation.Linknet.resnet18.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.Linknet.vgg11.imagenet/model.json">lung-segmentation.Linknet.vgg11.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.Linknet.vgg13.imagenet/model.json">lung-segmentation.Linknet.vgg13.imagenet</option>
          <option value="https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-inct-tfjs/master/lung-segmentation.Unet.mobilenet_v2.imagenet/model.json">lung-segmentation.Unet.mobilenet_v2.imagenet</option>
        </select>
      </div>
      <div style="position:absolute;bottom:0;">Made with 
        <a href="https://github.com/pbizopoulos/pyclientsideml">pyclientsideml</a>.
      </div>
    </div>
    <div id="divInput" style="width:256px;height:256px;position:fixed;top:0px;left:256px;">
      <canvas height="256" id="canvasImageInput" width="256"></canvas>
    </div>
    <div id="divOutput" style="width:256px;height:256px;position:fixed;top:0px;left:512px;">
      <canvas height="256" id="canvasImageOutput" width="256"></canvas>
      <canvas height="256" id="canvasMaskOutput" style="position:absolute;top:0px;left:0px;" width="256"></canvas>
    </div>
    <div class="modal" id="divModal">
      <div class="modal-content">
        <div id="tui-image-editor-container"></div>
      </div>
    </div>
    <script>const canvasWidth = 256;const canvasHeight = 256;const inputFilename = "https://raw.githubusercontent.com/pbizopoulos/comprehensive-comparison-of-deep-learning-models-for-lung-and-covid-19-lesion-segmentation-in-ct/master/docs/example-image.jpg";const predictionFunction = imageSegmentationPredictView;const pixelScaling = 0.011764705882352941;const pixelBaseline = 1.5;
const canvasImageInput = document.getElementById("canvasImageInput");
const contextImageInput = canvasImageInput.getContext("2d");
const canvasImageOutput = document.getElementById("canvasImageOutput");
const contextImageOutput = canvasImageOutput.getContext("2d");
const canvasMaskOutput = document.getElementById("canvasMaskOutput");
const contextMaskOutput = canvasMaskOutput.getContext("2d");
let imageInput = new Image();
const imageFileReader = new FileReader();
imageFileReader.onload = () => {
        imageInput.src = imageFileReader.result;
        };

imageInput.crossOrigin = 'anonymous';
imageInput.src = inputFilename;
imageInput.onload = () => {
        contextMaskOutput.clearRect(0, 0, canvasWidth, canvasHeight);
        contextImageOutput.clearRect(0, 0, canvasWidth, canvasHeight);
        contextImageInput.clearRect(0, 0, canvasWidth, canvasHeight);
        contextImageInput.drawImage(imageInput, 0, 0, imageInput.width, imageInput.height, 0, 0, canvasWidth, canvasHeight);
        imageSegmentationPredictView();
        };

function imageSegmentationLoadView() {
        const files = event.currentTarget.files;
        if (files[0]) {
            imageFileReader.readAsDataURL(files[0]);
            }
        }

function imageSegmentationPredictView(){
        if (model === undefined) {
            return;
            }
        tf.tidy(() => {
            let fromPixels = tf.browser.fromPixels(canvasImageInput);
            originalShape = fromPixels.shape.slice(0, 2);
            fromPixels = tf.image.resizeBilinear(fromPixels, [model.inputs[0].shape[2], model.inputs[0].shape[3]]);
            let pixels = fromPixels.slice([0, 0, 2]).squeeze(-1).expandDims(0).expandDims(0);
            pixels = pixels.mul(pixelScaling);
            pixels = pixels.sub(pixelBaseline);
            const mask = model.predict(pixels);
            let maskToPixels = mask.squeeze(0).squeeze(0);
            const alphaTensor = tf.tensor([0.3]);
            const alphaChannel = alphaTensor.where(maskToPixels.greaterEqual(0.5), 0);
            maskToPixels = tf.stack([maskToPixels, tf.zerosLike(maskToPixels), tf.zerosLike(maskToPixels), alphaChannel], -1);
            maskToPixels = tf.image.resizeBilinear(maskToPixels, originalShape);
            contextMaskOutput.clearRect(0, 0, canvasWidth, canvasHeight);
            contextImageOutput.clearRect(0, 0, canvasWidth, canvasHeight);
            contextImageOutput.drawImage(imageInput, 0, 0, imageInput.width, imageInput.height, 0, 0, canvasWidth, canvasHeight);
            tf.browser.toPixels(maskToPixels, canvasMaskOutput);
            });
        }

const imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
    includeUI: {
        initMenu: 'filter',
        loadImage: { path: imageInput.src },
        },
    usageStatistics: false,
    });
const divModal = document.getElementById('divModal');
canvasImageInput.onclick = function() {
        divModal.style.display = 'block';
        imageEditor.loadImageFromURL(imageInput.src, 'value')
        .then((result) => {
            document.getElementsByClassName('tui-image-editor-header-buttons')[0].style.display = 'none';
            imageEditor.ui.activeMenuEvent();
            });
        }
window.onclick = function(event) {
        if (event.target == divModal) {
            divModal.style.display = 'none';
            imageInput.src = imageEditor.toDataURL();
            imageSegmentationPredictView();
            }
        }

function disableUI(argument) {
        const nodes = document.getElementById('divInputControl').getElementsByTagName('*');
        for(let i = 0; i < nodes.length; i++){
            nodes[i].disabled = argument;
            }
        }

let model;
async function loadModel(predictFunction) {
        model = await tf.loadGraphModel(selectModel.value, {onProgress: disableUI(true)});
        predictFunction();
        disableUI(false);
        }
loadModel(predictionFunction);</script>
  </body>
</html>